<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Payment Entry - SCMS</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

<style>
    body {
        font-family: "Poppins", sans-serif;
        background: #f0f4f8;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        margin: 0;
    }

    .form-container {
        background: #fff;
        padding: 30px;
        border-radius: 20px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        max-width: 400px;
        width: 100%;
    }

    h2 {
        text-align: center;
        color: #005bbb;
        margin-bottom: 20px;
        font-weight: 700;
    }

    label {
        font-weight: 600;
        display: block;
        margin-top: 15px;
        color: #333;
    }

    input, select {
        width: 100%;
        padding: 12px;
        margin-top: 5px;
        border: 2px solid #ddd;
        border-radius: 10px;
        box-sizing: border-box;
        font-size: 15px;
        outline: none;
        transition: 0.3s;
        background-color: white;
    }

    /* Readonly ID field style */
    input[readonly] {
        background-color: #f9f9f9;
        color: #005bbb;
        font-weight: bold;
        border-style: dashed;
    }

    input:focus, select:focus {
        border-color: #005bbb;
    }

    .suggest-info {
        font-size: 11px;
        color: #005bbb;
        margin-top: 5px;
        font-weight: bold;
    }

    button {
        width: 100%;
        padding: 14px;
        background: #005bbb;
        color: white;
        border: none;
        border-radius: 10px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        margin-top: 25px;
        transition: 0.3s;
    }

    button:hover { background: #004488; }

    .popup {
        position: fixed;
        top: 0; left: 0;
        width: 100%; height: 100%;
        background: rgba(0,0,0,0.5);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 1000;
    }

    .popup-box {
        background: white;
        padding: 25px;
        border-radius: 15px;
        text-align: center;
        max-width: 300px;
    }
</style>
</head>
<body>

<div class="form-container">
    <h2>Payment Entry</h2>

    <form id="paymentForm" method="POST" 
          action="https://docs.google.com/forms/d/e/1FAIpQLSdDntwNFoZcogP9kJuDpizJDKFP9qA6unxpZrtvSRfIpyst-w/formResponse"
          target="hidden_iframe">

        <label>TNX-ID (Auto Generated)</label>
        <input type="text" id="tnxId" name="entry.1357149866" readonly required>
        <div id="suggestLabel" class="suggest-info">ðŸ”„ Syncing with Database...</div>

        <label>Date</label>
        <input type="date" id="entryDate" name="entry.1637781284" required>

        <label>Payment-By</label>
        <select id="paymentBy" name="entry.1554254909" required>
            <option value="">Loading Dropdown...</option>
        </select>

        <label>Amount</label>
        <input type="number" name="entry.1400255126" required placeholder="Enter amount">

        <button type="submit" id="submitBtn">Submit Payment</button>
    </form>

    <iframe name="hidden_iframe" id="hidden_iframe" style="display:none;"></iframe>
</div>

<div class="popup" id="successPopup">
    <div class="popup-box">
        <h3 style="color: #28a745;">âœ” Success!</h3>
        <p>Payment recorded successfully.</p>
        <button onclick="location.reload()">Add New Entry</button>
    </div>
</div>

<script>
    // CSV URL
    const paymentCsvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTAwqKg4QjdIUWQ31Nxl7wnkIRpx_H80Ddd7lsW4s0bgVowNL2xFSPhOYcB-RwwrO7b0x5lF61Yv03D/pub?gid=239856359&single=true&output=csv";

    const tnxInput = document.getElementById('tnxId');
    const suggestLabel = document.getElementById('suggestLabel');
    const paymentDropdown = document.getElementById('paymentBy');
    const dateInput = document.getElementById('entryDate');

    dateInput.valueAsDate = new Date();

    async function loadDataFromSheet() {
        try {
            const response = await fetch(paymentCsvUrl);
            const csvText = await response.text();
            
            // CSV parsing manually to handle rows correctly
            const rows = csvText.split(/\r?\n/).slice(1);
            
            let maxNum = 0;
            let payers = new Set();

            rows.forEach(row => {
                // Split by comma but ignore commas inside quotes
                const cols = row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                
                if (cols.length > 1) {
                    // 1. Get TNX-ID from Column B (Index 1)
                    let idVal = cols[1].replace(/"/g, '').trim();
                    if (idVal.includes('-')) {
                        let numPart = parseInt(idVal.split('-')[1]);
                        if (!isNaN(numPart) && numPart > maxNum) maxNum = numPart;
                    }

                    // 2. Get Payer Name from Column G (Index 6)
                    if (cols.length >= 7) {
                        let payerName = cols[6].replace(/"/g, '').trim();
                        if (payerName) payers.add(payerName);
                    }
                }
            });

            // Set Next ID
            const nextId = "SCMS-" + (maxNum + 1);
            tnxInput.value = nextId;
            suggestLabel.innerText = "Current ID: " + nextId;

            // Fill Dropdown
            paymentDropdown.innerHTML = '<option value="">-- Select Payer Name --</option>';
            const sortedPayers = Array.from(payers).sort();
            if (sortedPayers.length > 0) {
                sortedPayers.forEach(name => {
                    let opt = document.createElement('option');
                    opt.value = name;
                    opt.text = name;
                    paymentDropdown.appendChild(opt);
                });
            } else {
                paymentDropdown.innerHTML = '<option value="">No names found in Column G</option>';
            }

        } catch (e) {
            console.error(e);
            suggestLabel.innerText = "Error loading ID";
            paymentDropdown.innerHTML = '<option value="">Load Failed</option>';
        }
    }

    window.onload = loadDataFromSheet;

    const form = document.getElementById('paymentForm');
    const popup = document.getElementById('successPopup');
    const iframe = document.getElementById('hidden_iframe');
    let isSubmitting = false;

    form.onsubmit = function() {
        isSubmitting = true;
        document.getElementById('submitBtn').innerText = "Processing...";
    };

    iframe.onload = function() {
        if(isSubmitting) {
            popup.style.display = "flex";
            isSubmitting = false;
        }
    };
</script>

</body>
</html>
